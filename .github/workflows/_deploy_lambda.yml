name: Deploy Lambda Function
on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'The tag to deploy'
        required: true
        default: 'latest'
        type: string
  release:
    types: [ created ]
  push:
    tags:
    - 'v*'
    - '*.*.*'

run-name: Deploying ${{ github.event.inputs.tag || github.event.release.tag_name || github.ref_name || 'latest' }}
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Determine tag
      id: determine-tag
      run: |
        TAG="${{ github.event.inputs.tag || github.event.release.tag_name || github.ref_name || 'latest' }}"
        echo "ref_name=$TAG" >> $GITHUB_OUTPUT

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.determine-tag.outputs.ref_name }}

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Install dependencies
      run: npm install

    - name: Build project
      run: npm run build

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Deploy to AWS Lambda
      run: |
        FUNCTION_NAME="kms-hmac-function"
        ZIP_FILE="function.zip"

        # Create a zip file with the Lambda function code
        cd dist
        zip -r ../$ZIP_FILE index.js
        cd ..

        # Update Lambda function code
        aws lambda update-function-code \
          --function-name $FUNCTION_NAME \
          --zip-file fileb://$ZIP_FILE \
          --region ${{ secrets.AWS_REGION }}

        echo "âœ… Successfully deployed ${{ steps.determine-tag.outputs.ref_name }} to Lambda function: $FUNCTION_NAME"
